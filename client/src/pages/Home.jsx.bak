import React, { useEffect, useRef, useState, useCallback } from 'react';
import { getSportEmoji, SPORTS_LIST } from '../utils/sportsData';
import { searchAPI } from '../utils/api';
import './Home.css';

function Home({ user }) {
    const mapRef = useRef(null);
    const naverMapRef = useRef(null);
    const markersRef = useRef([]);
    const [searchQuery, setSearchQuery] = useState('');
    const [userLocation, setUserLocation] = useState(null);
    const [mapLoaded, setMapLoaded] = useState(false);
    const [searchError, setSearchError] = useState(null);
    const [currentRegion, setCurrentRegion] = useState({ area1: 'ÏÑúÏö∏', area2: '', area3: '' }); // Default to Seoul
    const [isSearching, setIsSearching] = useState(false);
    const currentInfoWindowRef = useRef(null); // Track currently open InfoWindow

    useEffect(() => {
        const loadNaverScript = () => {
            return new Promise((resolve, reject) => {
                if (window.naver && window.naver.maps) {
                    resolve(window.naver.maps);
                    return;
                }

                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=qk5p9qijo2&submodules=geocoder`;
                script.async = true;
                script.onload = () => {
                    // Wait for the geocoder submodule if requested via submodules param
                    window.naver.maps.onJSContentLoaded = () => resolve(window.naver.maps);
                    // Fallback if the event doesn't fire or for different versions
                    setTimeout(() => resolve(window.naver.maps), 500);
                };
                script.onerror = (err) => reject(new Error('ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú Ïã§Ìå®'));
                document.head.appendChild(script);
            });
        };

        const init = async () => {
            try {
                // 1. Load Script
                await loadNaverScript();

                // 2. Get Location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const location = { lat: position.coords.latitude, lng: position.coords.longitude };
                            setUserLocation(location);
                            initializeMap(location);
                        },
                        () => {
                            const defaultLoc = { lat: 37.5665, lng: 126.9780 };
                            setUserLocation(defaultLoc);
                            initializeMap(defaultLoc);
                        }
                    );
                } else {
                    const defaultLoc = { lat: 37.5665, lng: 126.9780 };
                    setUserLocation(defaultLoc);
                    initializeMap(defaultLoc);
                }
            } catch (error) {
                console.error('Initialization error:', error);
                setSearchError('ÏßÄÎèÑÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        };

        init();

        return () => {
            markersRef.current.forEach(marker => marker.setMap(null));
        };
    }, []);

    // Get current region name for better search results
    useEffect(() => {
        if (userLocation && window.naver?.maps?.Service) {
            window.naver.maps.Service.reverseGeocode({
                coords: new window.naver.maps.LatLng(userLocation.lat, userLocation.lng),
            }, (status, response) => {
                if (status === window.naver.maps.Service.Status.OK) {
                    const items = response.v2.results;
                    if (items.length > 0) {
                        const region = items[0].region;
                        // Use a more specific region if available (city + district)
                        setCurrentRegion({
                            area1: region.area1.name,
                            area2: region.area2.name,
                            area3: region.area3.name
                        });
                    }
                }
            });
        }
    }, [userLocation]);

    const initializeMap = (location) => {
        const mapOptions = {
            center: new window.naver.maps.LatLng(location.lat, location.lng),
            zoom: 14, // Slightly closer than example but standard for facilities
            zoomControl: true
        };

        const map = new window.naver.maps.Map(mapRef.current, mapOptions);
        naverMapRef.current = map;

        // Close InfoWindow when clicking on the map
        window.naver.maps.Event.addListener(map, 'click', () => {
            if (currentInfoWindowRef.current) {
                currentInfoWindowRef.current.close();
                currentInfoWindowRef.current = null;
            }
        });

        // Add modern user location marker
        new window.naver.maps.Marker({
            position: new window.naver.maps.LatLng(location.lat, location.lng),
            map: map,
            title: 'ÌòÑÏû¨ ÏúÑÏπò',
            icon: {
                content: `
                    <div style="
                        position: relative;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <!-- Outer pulse ring -->
                        <div style="
                            position: absolute;
                            width: 60px;
                            height: 60px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border-radius: 50%;
                            opacity: 0.3;
                            animation: pulse 2s ease-out infinite;
                        "></div>
                        <!-- Inner marker -->
                        <div style="
                            position: relative;
                            width: 40px;
                            height: 40px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border-radius: 50%;
                            border: 4px solid white;
                            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.6), 0 0 0 4px rgba(102, 126, 234, 0.2);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 18px;
                            z-index: 1;
                        ">
                            üìç
                        </div>
                    </div>
                    <style>
                        @keyframes pulse {
                            0% { transform: scale(0.8); opacity: 0.5; }
                            50% { transform: scale(1.2); opacity: 0.2; }
                            100% { transform: scale(1.5); opacity: 0; }
                        }
                    </style>
                `,
                anchor: new window.naver.maps.Point(30, 30)
            }
        });

        setMapLoaded(true);

        // Load initial markers will be done by the useEffect below
    };

    // Re-load facilities when user profile interests change (but not on region update to avoid excessive API calls)
    useEffect(() => {
        if (mapLoaded && userLocation) {
            console.log('üîÑ Reloading facilities due to dependency change');
            loadFacilities(userLocation, user?.selectedSports);
        }
    }, [user?.selectedSports, mapLoaded, userLocation]);

    // Helper to get region from coordinates
    const getRegionFromCoords = (lat, lng) => {
        return new Promise((resolve) => {
            window.naver.maps.Service.reverseGeocode({
                coords: new window.naver.maps.LatLng(lat, lng),
                orders: [window.naver.maps.Service.OrderType.ADDR, window.naver.maps.Service.OrderType.ROAD_ADDR].join(',')
            }, (status, response) => {
                if (status === window.naver.maps.Service.Status.OK) {
                    const result = response.v2.address;
                    resolve({
                        area1: result.jibunAddress ? result.jibunAddress.split(' ')[0] : '', // Ïãú/ÎèÑ
                        area2: result.jibunAddress ? result.jibunAddress.split(' ')[1] : '', // Ïãú/Íµ∞/Íµ¨
                    });
                } else {
                    resolve(null);
                }
            });
        });
    };

    // Load facilities based on user preferences or search
    const loadFacilities = async (location, selectedSports = null) => {
        // Clear existing markers
        markersRef.current.forEach(marker => marker.setMap(null));
        markersRef.current = [];
        setIsSearching(true);
        setSearchError(null);

        if (!selectedSports || selectedSports.length === 0) {
            // Default to popular sports for better initial results
            selectedSports = ['Ï∂ïÍµ¨', 'ÎÜçÍµ¨', 'ÏàòÏòÅ', 'Ìó¨Ïä§', 'ÏöîÍ∞Ä', 'ÌïÑÎùºÌÖåÏä§', 'ÌÉúÍ∂åÎèÑ', 'Ïú†ÎèÑ'];
        }

        console.log('üîç Starting facility search with sports:', selectedSports);
        console.log('üìç Search location:', location);

        // Helper to expand keyword into realistic search terms (optimized for speed)
        const getExpandedKeywords = (sport) => {
            const s = sport.replace(/Ïû•$/g, '').replace(/ÍµêÏã§$/g, '').trim();
            // Use only the MOST EFFECTIVE keywords to reduce API calls
            if (s === 'Ï∂ïÍµ¨') return ['Ï∂ïÍµ¨', 'ÌíÄÏÇ¥'];
            if (s === 'Ïú†ÎèÑ') return ['Ïú†ÎèÑ', 'Ïú†ÎèÑÍ¥Ä', 'Ïú†ÎèÑÏû•', 'Ïú†ÎèÑÏ≤¥Ïú°Í¥Ä', 'Ïú†ÎèÑÎèÑÏû•'];  // Core 3 keywords
            if (s === 'ÌÉúÍ∂åÎèÑ') return ['ÌÉúÍ∂åÎèÑ', 'ÌÉúÍ∂åÎèÑÏû•'];
            if (s === 'Î≥µÏã±') return ['Î≥µÏã±'];
            if (s === 'Ï£ºÏßìÏàò') return ['Ï£ºÏßìÏàò', 'BJJ'];
            if (s === 'Ìó¨Ïä§') return ['Ìó¨Ïä§', 'ÌîºÌä∏ÎãàÏä§'];
            if (s === 'ÏöîÍ∞Ä') return ['ÏöîÍ∞Ä'];
            if (s === 'ÌïÑÎùºÌÖåÏä§') return ['ÌïÑÎùºÌÖåÏä§'];
            if (s === 'ÎÜçÍµ¨') return ['ÎÜçÍµ¨'];
            if (s === 'ÏàòÏòÅ') return ['ÏàòÏòÅ', 'ÏàòÏòÅÏû•'];
            return [s]; // Default: just the base keyword
        };

        try {
            // 1. Identify all relevant nearby regions (Center + N/S/E/W 3km) to handle border areas
            // 1 degree lat approx 111km => 3km approx 0.027
            // 1 degree lng approx 88km => 3km approx 0.034
            const checkPoints = [
                { lat: location.lat, lng: location.lng }, // Center
                { lat: location.lat + 0.027, lng: location.lng }, // North 3km
                { lat: location.lat - 0.027, lng: location.lng }, // South 3km
                { lat: location.lat, lng: location.lng + 0.034 }, // East 3km
                { lat: location.lat, lng: location.lng - 0.034 }  // West 3km
            ];

            const regions = [];
            for (const point of checkPoints) {
                const region = await getRegionFromCoords(point.lat, point.lng);
                if (region && region.area1 && region.area2) {
                    regions.push(region);
                }
            }

            // Deduplicate regions (e.g., "ÏÑúÏö∏ Í∞ïÎÇ®Íµ¨", "Í≤ΩÍ∏∞ ÏÑ±ÎÇ®Ïãú")
            const uniqueRegions = regions.reduce((acc, current) => {
                const key = `${current.area1} ${current.area2}`;
                if (!acc.find(r => `${r.area1} ${r.area2}` === key)) {
                    acc.push(current);
                }
                return acc;
            }, []);

            console.log('üó∫Ô∏è Search Targets (Nearby Regions):', uniqueRegions.map(r => `${r.area1} ${r.area2}`));

            const allResults = [];

            // 2. Fetch all sports SEQUENTIALLY
            for (const sport of selectedSports) {
                const keywords = getExpandedKeywords(sport);

                for (const keyword of keywords) {
                    try {
                        const queries = [];

                        // Generate queries for ALL identified regions to ensure border coverage
                        for (const region of uniqueRegions) {
                            // "Region Keyword" (e.g., "Seoul Gangnam-gu Judo")
                            queries.push(`${region.area1} ${region.area2} ${keyword}`);
                        }

                        // Fallback: If no regions found (rare), use current known region
                        if (uniqueRegions.length === 0) {
                            queries.push(currentRegion ? `${currentRegion.area1} ${currentRegion.area2} ${keyword}` : keyword);
                        }

                        // Deduplicate queries
                        const uniqueQueries = [...new Set(queries)];

                        for (const fullQuery of uniqueQueries) {
                            let start = 1;
                            let hasMore = true;
                            // High accuracy search: 200 results per region query
                            const MAX_PER_QUERY = 200;

                            while (hasMore && start <= MAX_PER_QUERY) {
                                try {
                                    // 300ms delay to respect rate limits while keeping speed
                                    await new Promise(r => setTimeout(r, 300));

                                    // Pass start index to pagination
                                    const response = await searchAPI.searchLocal(fullQuery, location.lat, location.lng, start);
                                    const items = response.data.items || [];

                                    if (items.length > 0) {
                                        const taggedItems = items.map(item => ({ ...item, sport }));
                                        allResults.push(...taggedItems);

                                        // If we get fewer than requested (5 items), it means no more results (Naver API usually gives 5)
                                        if (items.length < 5) {
                                            hasMore = false;
                                        } else {
                                            start += 5; // Next page
                                        }
                                    } else {
                                        hasMore = false;
                                    }
                                } catch (e) {
                                    console.error(`API fail for ${fullQuery}:`, e.message);
                                    hasMore = false;
                                }
                            }

                            start += items.length;

                            // If we got fewer than requested (usually 5 or 100), end
                            if (items.length < 5) hasMore = false;
            }

        } catch (e) {
            console.error(`API fail for ${keyword}:`, e.message);
            // Don't throw here, just continue to next keyword/sport
            if (e.response?.status === 401 || e.response?.status === 403) {
                throw e;
            }
        }
    }
}

console.log('üìä Total search results:', allResults.length);

if (allResults.length === 0) {
    console.error('‚ùå No facilities found');
    setSearchError(`Ï£ºÎ≥Ä 50km Ïù¥ÎÇ¥ÏóêÏÑú Ïä§Ìè¨Ï∏† ÏãúÏÑ§ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Î•∏ ÏßÄÏó≠ÏùÑ Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî.`);
    return;
}

// Filter out irrelevant results (fire safety equipment, etc.)
const excludeKeywords = ['Ïú†ÎèÑÎì±', 'ÎπÑÏÉÅÍµ¨', 'ÏÜåÎ∞©', 'ÌôîÏû¨', 'Í≤ΩÎ≥¥Í∏∞', 'ÌÉêÏßÄ', 'ÌîºÎÇú', 'ÏïàÏ†Ñ'];
const filteredResults = allResults.filter(item => {
    const title = item.title.replace(/<[^>]*>/g, '').toLowerCase();
    // Exclude if title contains any of the exclude keywords
    const shouldExclude = excludeKeywords.some(keyword => title.includes(keyword));
    if (shouldExclude) {
        console.log(`üö´ Excluded irrelevant result:`, item.title.replace(/<[^>]*>/g, ''));
    }
    return !shouldExclude;
});

console.log(`‚úÇÔ∏è Filtered ${allResults.length - filteredResults.length} irrelevant results. Remaining: ${filteredResults.length}`);

if (filteredResults.length === 0) {
    setSearchError(`Í¥ÄÎ†® ÏãúÏÑ§ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
    return;
}

// 2. Deduplicate filtered results
const uniqueItems = filteredResults.filter((item, index, self) =>
    index === self.findIndex((t) => t.address === item.address)
);

// 3. Geocode and Create markers for ALL items
const bounds = new window.naver.maps.LatLngBounds();
let markerCount = 0;

// Haversine formula to calculate distance between two points
const getDistanceFromLatLonInKm = (lat1, lon1, lat2, lon2) => {
    const R = 6371; // Radius of the earth in km
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const d = R * c; // Distance in km
    return d;
};

const deg2rad = (deg) => {
    return deg * (Math.PI / 180);
};

// Collection array for sorting
const validFacilities = [];

await Promise.all(uniqueItems.map(async (item) => {
    let latlng = null;
    try {

        // Geocode address if coordinates missing
        if (item.address) {
            const geocodeRes = await new Promise((resolve) => {
                window.naver.maps.Service.geocode({ query: item.address }, (status, response) => {
                    if (status === window.naver.maps.Service.Status.OK && response.v2.addresses.length > 0) {
                        const addr = response.v2.addresses[0];
                        resolve(new window.naver.maps.LatLng(addr.y, addr.x));
                    } else {
                        resolve(null);
                    }
                });
            });
            if (geocodeRes) latlng = geocodeRes;
        }
    } catch (e) {
        console.warn('Coordinate conversion failed:', e);
    }

    if (latlng) {
        // Filter by distance (5km)
        const targetLat = typeof latlng.lat === 'function' ? latlng.lat() : latlng.y;
        const targetLng = typeof latlng.lng === 'function' ? latlng.lng() : latlng.x;

        // Debug: Log coordinates for first item
        if (validFacilities.length === 0) {
            console.log('üéØ First item coordinates:', {
                userLat: location.lat,
                userLng: location.lng,
                facilityLat: targetLat,
                facilityLng: targetLng,
                title: item.title.replace(/<[^>]*>/g, '')
            });
        }

        const distance = getDistanceFromLatLonInKm(
            location.lat, location.lng,
            targetLat, targetLng
        );

        // Debug log for distance calculation
        if (validFacilities.length < 10) {
            console.log(`üìè Distance: ${item.title.replace(/<[^>]*>/g, '')} - ${distance.toFixed(2)}km ${distance <= 5 ? '‚úÖ' : '‚ùå'}`);
        }

        if (distance <= 5) { // Show all facilities within 5km
            validFacilities.push({ ...item, latlng, distance });
        }
    }
}));

// Sort by distance (closest first) - show ALL facilities within 5km
validFacilities.sort((a, b) => a.distance - b.distance);

console.log(`‚úÖ Found ${validFacilities.length} valid facilities within 5km`);
if (validFacilities.length > 0) {
    console.log('üéØ Displaying ALL facilities:', validFacilities.map(f => ({ name: f.title.replace(/<[^>]*>?/gm, ''), distance: f.distance.toFixed(2) + 'km', sport: f.sport })));
}

validFacilities.forEach(facility => {
    const emoji = getSportEmoji(facility.sport);
    createMarker(facility.latlng, emoji, facility, facility.sport);
    bounds.extend(facility.latlng);
    markerCount++;
});

console.log(`üó∫Ô∏è Created ${markerCount} markers on the map`);

// 4. Fit map to show all markers
if (markerCount > 0 && naverMapRef.current) {
    naverMapRef.current.fitBounds(bounds, {
        top: 50, bottom: 50, left: 20, right: 20
    });
}

                    } catch (error) {
    console.error('Failed to load facilities:', error);
    if (error.response?.status === 401 || error.response?.status === 403) {
        const guidance = error.response?.data?.guidance;
        setSearchError(guidance ? `ÏÑúÎπÑÏä§ Ïù∏Ï¶ù Ïã§Ìå®: ${guidance}` : `Ïù∏Ï¶ù Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.`);
    } else {
        setSearchError(`ÏãúÏÑ§ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.`);
    }
} finally {
    setIsSearching(false);
}
                };

const createMarker = (latlng, emoji, item, sport) => {
    // Generate a consistent pastel color string from a string
    const stringToColor = (str) => {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
        return '#' + '00000'.substring(0, 6 - c.length) + c;
    };

    // Define some nice colors for common sports
    const sportColors = {
        'Ï∂ïÍµ¨': '#e53e3e', // Red
        'ÎÜçÍµ¨': '#dd6b20', // Orange
        'Ïú†ÎèÑ': '#3182ce', // Blue
        'ÌÉúÍ∂åÎèÑ': '#38a169', // Green
        'ÏàòÏòÅ': '#0bc5ea', // Cyan
        'Î≥µÏã±': '#d53f8c', // Pink
        'Ï£ºÏßìÏàò': '#805ad5', // Purple
    };

    const markerColor = sportColors[sport] || stringToColor(sport);

    const marker = new window.naver.maps.Marker({
        position: latlng,
        map: naverMapRef.current,
        title: item.title.replace(/<[^>]*>?/gm, ''),
        icon: {
            content: `
                    <div class="custom-marker" style="
                        position: relative;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        width: 44px;
                        height: 44px;
                        background: white;
                        border-radius: 50%;
                        border: 3px solid ${markerColor};
                        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                        cursor: pointer;
                        transition: transform 0.2s;
                    ">
                        <div style="font-size: 24px; line-height: 1;">${emoji}</div>
                        <div style="
                            position: absolute;
                            bottom: -5px;
                            background: ${markerColor};
                            color: white;
                            font-size: 10px;
                            padding: 2px 6px;
                            border-radius: 10px;
                            font-weight: bold;
                            white-space: nowrap;
                        ">${sport}</div>
                    </div>
                `,
            anchor: new window.naver.maps.Point(22, 22)
        }
    });

    const infoWindow = new window.naver.maps.InfoWindow({
        content: `
                <div style="padding: 15px; background: #1a202c; color: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); min-width: 250px; border: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="margin: 0 0 10px 0; font-size: 1.15rem; color: #4299e1; font-weight: 800;">${item.title.replace(/<[^>]*>?/gm, '')}</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <p style="margin: 0; font-size: 0.95rem; color: #e2e8f0; display: flex; align-items: center; gap: 5px;">
                            <span style="color: #4299e1;">${emoji}</span> <strong>Ï¢ÖÎ™©:</strong> ${sport}
                        </p>
                        <p style="margin: 0; font-size: 0.9rem; color: #cbd5e0; line-height: 1.4;">
                            <span style="color: #4299e1;">üìç</span> <strong>ÏúÑÏπò:</strong> ${item.address}
                        </p>
                    </div>
                    <a href="https://search.naver.com/search.naver?query=${encodeURIComponent(item.title.replace(/<[^>]*>?/gm, ''))}" target="_blank" style="display: inline-block; margin-top: 15px; background: #4299e1; color: white; padding: 8px 15px; border-radius: 8px; text-decoration: none; font-size: 0.85rem; font-weight: 600; text-align: center; transition: background 0.2s;">ÏÉÅÏÑ∏Î≥¥Í∏∞ (ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ)</a>
                </div>
            `,
        backgroundColor: "transparent",
        borderWidth: 0,
        disableAnchor: true
    });

    window.naver.maps.Event.addListener(marker, 'click', () => {
        // Close previous InfoWindow if exists
        if (currentInfoWindowRef.current) {
            currentInfoWindowRef.current.close();
        }
        // Open new InfoWindow
        infoWindow.open(naverMapRef.current, marker);
        currentInfoWindowRef.current = infoWindow;
        naverMapRef.current.panTo(latlng, { duration: 500 });
    });

    markersRef.current.push(marker);
};

// Removed generateMockFacilities as we are now using real data

// Handle search
const handleSearch = (e) => {
    e.preventDefault();
    if (!searchQuery.trim() || !userLocation) return;

    // Search for specific facilities
    const searchResults = SPORTS_LIST.filter(sport =>
        sport.name.includes(searchQuery) ||
        sport.keywords.some(k => k.includes(searchQuery.toLowerCase()))
    );

    if (searchResults.length > 0) {
        const sportsNames = searchResults.map(s => s.name);
        loadFacilities(userLocation, sportsNames);
    } else {
        // Generic search - add " Í∑ºÏ≤ò" to make it more like a real place search
        loadFacilities(userLocation, [searchQuery]);
    }
};

return (
    <div className="home-page">
        {/* Fullscreen Map */}
        <div ref={mapRef} className="map-fullscreen">
            {(searchError || isSearching) && (
                <div className="search-error-overlay glass-container">
                    {isSearching ? (
                        <div className="flex items-center gap-md">
                            <div className="spinner-small"></div>
                            <span>Ï£ºÎ≥Ä ÏãúÏÑ§ÏùÑ Ï∞æÎäî Ï§ë...</span>
                        </div>
                    ) : (
                        <p>{searchError}</p>
                    )}
                </div>
            )}
        </div>

        {/* Floating Search Bar */}
        <div className="search-floating glass-container fade-in">
            <form onSubmit={handleSearch} className="search-form">
                <input
                    type="text"
                    id="search-input-home"
                    name="searchQuery"
                    className="search-input-home"
                    placeholder={
                        user?.selectedSports?.length > 0
                            ? `Í∑ºÏ≤ò ${user.selectedSports[0]} Í≤ÄÏÉâ...`
                            : "Í∑ºÏ≤ò Ïä§Ìè¨Ï∏† ÏãúÏÑ§ Í≤ÄÏÉâ..."
                    }
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                />
                <button type="submit" className="btn btn-primary search-btn">
                    Ï∞æÍ∏∞
                </button>
            </form>
        </div>

        <button
            className="my-location-btn"
            onClick={() => userLocation && naverMapRef.current.panTo(new window.naver.maps.LatLng(userLocation.lat, userLocation.lng))}
            title="ÎÇ¥ ÏúÑÏπòÎ°ú Ïù¥Îèô"
            style={{
                position: 'absolute',
                bottom: '30px',
                right: '20px',
                width: '56px',
                height: '56px',
                borderRadius: '16px',
                border: 'none',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white',
                fontSize: '24px',
                cursor: 'pointer',
                boxShadow: '0 8px 24px rgba(102, 126, 234, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2)',
                transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                backdropFilter: 'blur(10px)',
                WebkitBackdropFilter: 'blur(10px)'
            }}
            onMouseOver={(e) => {
                e.currentTarget.style.transform = 'translateY(-4px) scale(1.05)';
                e.currentTarget.style.boxShadow = '0 12px 32px rgba(102, 126, 234, 0.5), 0 6px 16px rgba(0, 0, 0, 0.25)';
            }}
            onMouseOut={(e) => {
                e.currentTarget.style.transform = 'translateY(0) scale(1)';
                e.currentTarget.style.boxShadow = '0 8px 24px rgba(102, 126, 234, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2)';
            }}
        >
            üéØ
        </button>

        {
            !mapLoaded && (
                <div className="map-loading">
                    <div className="spinner"></div>
                    <p>ÏßÄÎèÑÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                </div>
            )
        }
    </div >
);
            }

export default Home;
